@model ProblemSolvingPlatform.Models.Probleme
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ProblemSolvingPlatform.Models.User> SignInManager
@inject UserManager<ProblemSolvingPlatform.Models.User> UserManager

@{
    Layout = "_Layout";
    ViewData["Title"] = "Problem Details";
    var isAdmin = User.IsInRole("Admin");

    var testsJson = "[]";
    if (!string.IsNullOrEmpty(Model.TestCases))
    {
        try
        {
            var parsed = System.Text.Json.JsonSerializer.Deserialize<object>(Model.TestCases);
            testsJson = System.Text.Json.JsonSerializer.Serialize(parsed);
        }
        catch
        {
            testsJson = "[]";
        }
    }
}

<!-- HERO -->
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%); border-bottom: 1px solid rgba(255,255,255,0.1);">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a asp-action="Index" class="text-white-50 text-decoration-none">Problems</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Details</li>
                    </ol>
                </nav>
                <h1 class="fw-bold text-white mb-2 display-6">@Model.Title</h1>
                <div class="d-flex gap-2">
                    <span class="badge rounded-pill @(Model.Difficulte == "Easy" ? "bg-success-subtle text-success border border-success" : Model.Difficulte == "Medium" ? "bg-warning-subtle text-warning border border-warning" : "bg-danger-subtle text-danger border border-danger") px-3">@Model.Difficulte</span>
                    <span class="badge rounded-pill bg-white bg-opacity-10 text-white-50 border border-white border-opacity-10 px-3">@Model.Language?.ToUpper()</span>
                    <span class="text-white-50 ms-2 small"><i class="bi bi-hash me-1"></i> #@Model.ProbId</span>
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                @if (isAdmin)
                {
                    <a asp-action="Edit" asp-route-id="@Model.ProbId" class="btn btn-outline-warning btn-sm rounded-pill px-3 me-2">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </a>
                }
                <a asp-action="Index" class="btn btn-outline-light btn-sm rounded-pill px-3">
                    <i class="bi bi-arrow-left me-1"></i> List
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid page-content py-4">
    <div class="container">
        <div class="row g-4">
            <!-- Left: Description (Increased Width to 5) -->
            <div class="col-lg-5">
                <div class="card bg-dark border-secondary shadow-lg h-100" style="border-radius: 1.5rem;">
                    <div class="card-header bg-black bg-opacity-50 border-bottom border-secondary p-4">
                        <h4 class="fw-bold text-white mb-0"><i class="bi bi-file-text me-2 text-primary"></i> Description</h4>
                    </div>
                    <div class="card-body p-4" style="max-height: 1000px; overflow-y: auto;">
                        <div class="problem-description text-white-50 lh-lg">
                            @Html.Raw(Model.Descr)
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.FunctionTemplate))
                        {
                            <div class="mt-4">
                                <h6 class="text-white small text-uppercase fw-bold mb-2">Base Template</h6>
                                <div class="bg-black rounded-3 p-3 border border-secondary">
                                    <pre class="mb-0 text-info small"><code>@Model.FunctionTemplate</code></pre>
                                </div>
                            </div>
                        }

                        <div class="mt-4 pt-4 border-top border-secondary d-flex gap-2">
                            @if (isAdmin)
                            {
                                <a asp-action="Edit" asp-route-id="@Model.ProbId" class="btn btn-outline-warning btn-sm rounded-pill px-3">
                                    <i class="bi bi-pencil me-1"></i> Edit
                                </a>
                                <a asp-action="Delete" asp-route-id="@Model.ProbId" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                                    <i class="bi bi-trash me-1"></i> Delete
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Code Editor (Decreased Width to 7) -->
            <div class="col-lg-7">
                <div class="card bg-dark border-secondary shadow-lg mb-4" style="border-radius: 1.5rem; overflow: hidden;">
                    <div class="card-header bg-black border-bottom border-secondary p-4 d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold text-white mb-0"><i class="bi bi-terminal me-2 text-success"></i> Solution</h4>
                        </div>
                        <div class="d-flex gap-3">
                            <select id="languageSelect" class="form-select form-select-sm bg-black border-secondary text-white rounded-pill px-3" style="width: 140px;">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="csharp">C#</option>
                            </select>
                        </div>
                    </div>

                    <div class="card-body p-0 position-relative">
                        <div id="monaco-editor-container" style="height: 600px; width: 100%;"></div>
                        <textarea id="codeEditor" class="form-control d-none">@(string.IsNullOrEmpty(Model.FunctionTemplate) ? "def solution():\n    pass" : Model.FunctionTemplate)</textarea>
                    </div>

                    <div class="card-footer bg-black bg-opacity-50 border-top border-secondary p-4">
                        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
                            <div class="d-flex gap-2">
                                <button id="runBtn" class="btn btn-success rounded-pill px-4 fw-bold">
                                    <i class="bi bi-play-fill me-1"></i> Run
                                </button>
                                <button id="testBtn" class="btn btn-outline-info rounded-pill px-4 fw-bold">
                                    <i class="bi bi-check2-all me-1"></i> Run Tests
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="submitBtn" class="btn btn-primary rounded-pill px-4 fw-bold shadow">
                                    <i class="bi bi-cloud-arrow-up me-1"></i> Submit Solution
                                </button>
                                <button id="clearBtn" class="btn btn-outline-secondary rounded-circle p-2" title="Reset">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Input and Results Area -->
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="card bg-dark border-secondary h-100" style="border-radius: 1rem;">
                            <div class="card-body p-3">
                                <label class="small text-white-50 text-uppercase fw-bold mb-2">Custom Input</label>
                                <textarea id="inputEditor" class="form-control bg-black border-secondary text-white font-monospace" rows="5" placeholder="[1, 2, 3], 4" style="border-radius: 0.8rem;"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card bg-dark border-secondary h-100" style="border-radius: 1rem;">
                            <div class="card-body p-3">
                                <label class="small text-white-50 text-uppercase fw-bold mb-2">Console Output</label>
                                <div id="outputEditor" class="bg-black text-info p-3 font-monospace small" style="border-radius: 0.8rem; height: 180px; overflow-y: auto; white-space: pre-wrap;">Output will appear here...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="testResults" class="mt-4" style="display: none;">
                    <!-- Test cases results here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #monaco-editor-container .monaco-editor,
    #monaco-editor-container .overflow-guard { border-radius: 0 !important; }
    .problem-description h1, .problem-description h2, .problem-description h3 { color: white; margin-top: 1rem; }
    .problem-description code { background: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 4px; color: #60a5fa; }
</style>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        var editor = null;
        const testCases = @Html.Raw(testsJson);
        const initialCode = document.getElementById('codeEditor').value;
        const monacoContainer = document.getElementById('monaco-editor-container');
        const textareaFallback = document.getElementById('codeEditor');
        const outputEditor = document.getElementById('outputEditor');
        const testResults = document.getElementById('testResults');

        // Safe Monaco loader
        try {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                try {
                    editor = monaco.editor.create(monacoContainer, {
                        value: initialCode,
                        language: 'python',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: false }
                    });
                    // hide textarea when Monaco ready
                    textareaFallback.style.display = 'none';
                    // map language
                    document.getElementById('languageSelect').addEventListener('change', function(e){
                        var lang = e.target.value;
                        var monacoLang = 'python';
                        if(lang==='javascript') monacoLang='javascript';
                        if(lang==='java') monacoLang='java';
                        if(lang==='cpp') monacoLang='cpp';
                        if(lang==='csharp') monacoLang='csharp';
                        monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
                    });
                } catch (err) {
                    console.error('Monaco init failed', err);
                    monacoContainer.style.display = 'none';
                    textareaFallback.style.display = 'block';
                }
            });
        } catch (err) {
            console.error('Require/Monaco load failed', err);
            monacoContainer.style.display = 'none';
            textareaFallback.style.display = 'block';
        }

        function getCodeValue(){
            return editor ? editor.getValue() : document.getElementById('codeEditor').value;
        }

        document.getElementById('runBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            const input = document.getElementById('inputEditor').value || '';
            if(!code){ alert('Please write code'); return; }
            outputEditor.textContent = 'Running...';

            try{
                const resp = await fetch('@Url.Action("ExecuteCodeWithPiston","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ code: code, language: language, input: input })
                });

                if(resp.ok){
                    const data = await resp.json().catch(()=>null);
                    let out = (data && (data.output || data.stdout)) || '';
                    if(data && data.stderr) out += '\n\nError:\n' + data.stderr;
                    if(data && data.compile && data.compile.stderr) out = 'Compilation Error:\n' + data.compile.stderr;
                    outputEditor.textContent = out || 'Execution completed with no output.';
                    testResults.style.display = 'none';
                } else {
                    // try to extract meaningful error message
                    let msg = '';
                    try{ const j = await resp.json(); msg = j?.error || j?.message || JSON.stringify(j); } catch { msg = await resp.text(); }
                    outputEditor.textContent = 'Execution failed: ' + (msg || resp.statusText);
                }
            } catch(e){ outputEditor.textContent = 'Error: '+ e.message; }
        });

        document.getElementById('testBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            if(!code){ alert('Please write code'); return; }
            if(!Array.isArray(testCases) || testCases.length===0){ alert('No test cases defined'); return; }

            testResults.style.display = 'block';
            testResults.innerHTML = '<div class="d-flex flex-column align-items-center mt-3"><div class="spinner-border text-primary mb-2"></div><div class="text-white-50">Running tests...</div></div>';

            try{
                const resp = await fetch('@Url.Action("RunTests","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ Code: code, Language: language, Tests: testCases })
                });

                if(resp.ok){
                    const data = await resp.json().catch(()=>null);

                    function normalize(val){
                        if(val === null || val === undefined) return '';
                        if(typeof val === 'object') return JSON.stringify(val);
                        return String(val).replace(/\r/g,'').trim();
                    }

                    function tryParseJson(str){
                        try{ return JSON.parse(str); } catch { return null; }
                    }

                    function escapeHtml(unsafe){
                        return String(unsafe)
                          .replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&#039;');
                    }

                    if(data && data.results && Array.isArray(data.results)){
                        let passed = 0, failed = 0;
                        let html = '<div class="mb-3 p-2"><strong class="text-white">Test Results</strong></div>';

                        data.results.forEach((r,i)=>{
                            const tc = testCases[i] || {};
                            let expected = '';
                            if(tc.expected !== undefined) expected = tc.expected;
                            else if(tc.output !== undefined) expected = tc.output;
                            else if(tc.expectedOutput !== undefined) expected = tc.expectedOutput;

                            let actual = '';
                            if(r.output !== undefined) actual = r.output;
                            else if(r.stdout !== undefined) actual = r.stdout;
                            else if(r.result !== undefined) actual = r.result;
                            else if(r.raw !== undefined) actual = r.raw;
                            else if(r.stdout_raw !== undefined) actual = r.stdout_raw;
                            else actual = r;

                            const normAct = normalize(actual);
                            const normExp = normalize(expected);

                            let match = false;
                            const parsedA = tryParseJson(normAct);
                            const parsedE = tryParseJson(normExp);
                            if(parsedA !== null && parsedE !== null){
                                try{ match = JSON.stringify(parsedA) === JSON.stringify(parsedE); } catch { match = normAct === normExp; }
                            } else {
                                match = normAct === normExp;
                            }

                            if(r.status && r.status.toLowerCase() === 'error'){
                                failed++;
                                html += `<div class="mb-3 p-3 rounded bg-danger bg-opacity-10 border border-danger"><strong class="text-danger">Test ${i+1} - Error</strong><div class="mt-2"><pre class="mb-0">${escapeHtml(r.error || JSON.stringify(r))}</pre></div></div>`;
                            } else if(match){
                                passed++;
                                html += `<div class="mb-2 p-2 rounded bg-success bg-opacity-10 border border-success"><strong class="text-success">Test ${i+1} - Passed</strong></div>`;
                            } else {
                                failed++;
                                html += `<div class="mb-3 p-3 rounded bg-danger bg-opacity-10 border border-danger">
                                            <div><strong class="text-danger">Test ${i+1} - Failed</strong></div>
                                            <div class="mt-2 small"><span class="text-white-50">Input:</span> <pre class="mb-1">${escapeHtml(tc.input ?? tc.args ?? '')}</pre></div>
                                            <div class="row">
                                                <div class="col-md-6"><div class="small text-white-50">Expected</div><pre class="bg-black p-2 text-white">${escapeHtml(normExp)}</pre></div>
                                                <div class="col-md-6"><div class="small text-white-50">Actual</div><pre class="bg-black p-2 text-white">${escapeHtml(normAct)}</pre></div>
                                            </div>
                                        </div>`;
                            }
                        });

                        const summary = `<div class="mb-3 p-3 rounded bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center"><div><strong class="text-white">Summary</strong></div><div><span class="text-success me-3">${passed} Passed</span><span class="text-danger">${failed} Failed</span></div></div>`;
                        testResults.innerHTML = summary + html;
                    } else if(data && (data.raw || data.output)){
                        testResults.innerHTML = `<pre class="text-white">${escapeHtml(data.raw || data.output)}</pre>`;
                    } else {
                        testResults.innerHTML = '<div class="text-white-50">No results returned</div>';
                    }
                } else {
                    let msg = '';
                    try{ const j = await resp.json(); msg = j?.error || j?.message || JSON.stringify(j); } catch { msg = await resp.text(); }
                    testResults.innerHTML = '<div class="text-danger">Failed to run tests: '+ (msg || resp.statusText) +'</div>';
                }
            } catch(e){ testResults.innerHTML = '<div class="text-danger">Error: '+escapeHtml(e.message)+'</div>'; }
        });

        document.getElementById('clearBtn').addEventListener('click', function(){
            if(!confirm('Reset editor to initial template?')) return;
            if(editor) editor.setValue(initialCode);
            else document.getElementById('codeEditor').value = initialCode;
            outputEditor.textContent = 'Output will appear here...';
            testResults.style.display = 'none';
        });

        document.getElementById('submitBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            if(!code){ alert('Please write code'); return; }
            if(!confirm('Submit your solution?')) return;
            this.disabled = true; const btn = this;

            try{
                const resp = await fetch('@Url.Action("SubmitSolution","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ ProblemId: @Model.ProbId, Code: code, Language: language })
                });

                if(resp.ok){ const result = await resp.json().catch(()=>null); alert(result?.message || 'Submission complete'); }
                else {
                    // Show server error message when available
                    let errMsg = '';
                    try{ const j = await resp.json(); errMsg = j?.error || j?.message || JSON.stringify(j); } catch { errMsg = await resp.text(); }
                    alert('Submission failed: ' + (errMsg || resp.statusText));
                }
            } catch(e){ alert('Error: ' + e.message); }
            finally{ btn.disabled = false; }
        });
    </script>
}

