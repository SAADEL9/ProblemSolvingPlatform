@model ProblemSolvingPlatform.Models.Probleme
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ProblemSolvingPlatform.Models.User> SignInManager
@inject UserManager<ProblemSolvingPlatform.Models.User> UserManager

@{
    ViewData["Title"] = "Problem Details";
    var isAdmin = User.IsInRole("Admin");

    // Prepare test cases JSON safely for embedding in JS
    var testsJson = "[]";
    if (!string.IsNullOrEmpty(Model.TestCases))
    {
        try
        {
            var parsed = System.Text.Json.JsonSerializer.Deserialize<object>(Model.TestCases);
            testsJson = System.Text.Json.JsonSerializer.Serialize(parsed);
        }
        catch
        {
            testsJson = "[]";
        }
    }
}

<!-- Hero Header -->
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h1 class="fw-bold mb-2">
                    <i class="bi bi-code-square"></i> @Model.Title
                </h1>
                <p class="mb-0 text-white-50">
                    <i class="bi bi-hash"></i> Problem #@Model.ProbId
                </p>
            </div>
            <div class="text-end">
                <a asp-action="Index" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Problems
                </a>
            </div>
        </div>
        <div class="d-flex gap-2">
            <span class="badge
                @(Model.Difficulte == "Easy" ? "bg-success" :
                  Model.Difficulte == "Medium" ? "bg-warning text-dark" :
                  "bg-danger")" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                <i class="bi bi-speedometer2"></i> @Model.Difficulte
            </span>
            <span class="badge bg-info" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                <i class="bi bi-code"></i> @(Model.Language?.ToUpper() ?? "PYTHON")
            </span>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row g-4">
        <!-- Left Sidebar: Problem Details -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Problem Description
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="fw-semibold text-muted mb-2">
                            <i class="bi bi-file-text"></i> Description
                        </h6>
                        <p class="mb-0 text-dark" style="line-height: 1.6;">
                            @Model.Descr
                        </p>
                    </div>

                    <div class="mb-4">
                        <h6 class="fw-semibold text-muted mb-2">
                            <i class="bi bi-star"></i> Difficulty
                        </h6>
                        <span class="badge
                            @(Model.Difficulte == "Easy" ? "bg-success" :
                              Model.Difficulte == "Medium" ? "bg-warning text-dark" :
                              "bg-danger")">
                            @Model.Difficulte
                        </span>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.FunctionTemplate))
                    {
                        <div class="mb-4">
                            <h6 class="fw-semibold text-muted mb-2">
                                <i class="bi bi-function"></i> Function to Implement
                            </h6>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.85rem;"><code>@Model.FunctionTemplate</code></pre>
                        </div>
                    }

                    @if (isAdmin)
                    {
                        <div class="d-flex gap-2 mt-4">
                            <a asp-action="Edit" asp-route-id="@Model.ProbId" class="btn btn-warning flex-grow-1 btn-sm">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.ProbId" class="btn btn-danger flex-grow-1 btn-sm">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Section: Modern Code Editor & Test Results -->
        <div class="col-lg-8">
            <!-- Code Editor Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border-bottom: 2px solid #667eea;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="bi bi-terminal"></i> Code Compiler
                            </h5>
                            <small class="text-white-50">Using Piston API</small>
                        </div>
                        <select id="languageSelect" class="form-select form-select-sm" style="width: 180px; background-color: #334155; color: #e2e8f0; border-color: #667eea;">
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="csharp">C#</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                            <option value="php">PHP</option>
                            <option value="ruby">Ruby</option>
                            <option value="typescript">TypeScript</option>
                        </select>
                    </div>
                </div>

                <!-- Code Editor with Tabs -->
                <div class="card-body p-0" style="min-height: 500px; display: flex; flex-direction: column;">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="editorTabs" role="tablist" style="background-color: #f1f5f9; border-bottom: 2px solid #e2e8f0; margin: 0;">
                        <li class="nav-item">
                            <button class="nav-link active" id="code-tab" data-bs-toggle="tab" data-bs-target="#code-pane" style="color: #64748b; border: none; border-bottom: 3px solid transparent;">
                                <i class="bi bi-code"></i> Code
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="input-tab" data-bs-toggle="tab" data-bs-target="#input-pane" style="color: #64748b; border: none; border-bottom: 3px solid transparent;">
                                <i class="bi bi-arrow-down"></i> Input
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="output-tab" data-bs-toggle="tab" data-bs-target="#output-pane" style="color: #64748b; border: none; border-bottom: 3px solid transparent;">
                                <i class="bi bi-arrow-up"></i> Output
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests-pane" style="color: #64748b; border: none; border-bottom: 3px solid transparent;">
                                <i class="bi bi-check-circle"></i> Test Results
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content flex-grow-1" id="editorTabContent" style="display: flex; flex-direction: column;">
                        <!-- Code Editor -->
                        <div class="tab-pane fade show active" id="code-pane" style="flex-grow: 1; display: flex; flex-direction: column;">
                            <textarea id="codeEditor" class="form-control" style="flex-grow: 1; border: none; border-radius: 0; font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 14px; background-color: #1e293b; color: #e2e8f0; resize: none; padding: 15px;">@(string.IsNullOrEmpty(Model.FunctionTemplate) ? "def solution():\n    pass" : Model.FunctionTemplate)</textarea>
                        </div>

                        <!-- Input Pane -->
                        <div class="tab-pane fade" id="input-pane" style="flex-grow: 1; display: flex; flex-direction: column;">
                            <textarea id="inputEditor" class="form-control" style="flex-grow: 1; border: none; border-radius: 0; font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 13px; background-color: #1e293b; color: #e2e8f0; resize: none; padding: 15px;" placeholder="Enter test input here..."></textarea>
                        </div>

                        <!-- Output Pane -->
                        <div class="tab-pane fade" id="output-pane" style="flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto;">
                            <pre id="outputEditor" style="background-color: #1e293b; color: #e2e8f0; padding: 15px; margin: 0; border-radius: 0; font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 13px; flex-grow: 1; overflow-y: auto;">Output will appear here...</pre>
                        </div>

                        <!-- Test Results Pane -->
                        <div class="tab-pane fade" id="tests-pane" style="flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto;">
                            <div id="testResults" style="padding: 15px; background-color: #f1f5f9;">
                                <p class="text-muted">Run tests to see results</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card-footer" style="background-color: #f1f5f9; border-top: 1px solid #e2e8f0; padding: 12px;">
                    <div class="d-flex gap-2">
                        <button id="runBtn" class="btn btn-success flex-grow-1">
                            <i class="bi bi-play-fill"></i> Run Code
                        </button>
                        <button id="testBtn" class="btn btn-info flex-grow-1">
                            <i class="bi bi-check-circle"></i> Run Tests
                        </button>
                        <button id="clearBtn" class="btn btn-outline-secondary flex-grow-1">
                            <i class="bi bi-arrow-clockwise"></i> Clear
                        </button>
                        <button id="submitBtn" class="btn flex-grow-1" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                            <i class="bi bi-check-circle"></i> Submit Solution
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="spinner-border text-primary d-none" role="status" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; width: 60px; height: 60px;">
    <span class="visually-hidden">Loading...</span>
</div>

<style>
    /* Modern Code Editor Styling */
    #codeEditor:focus, #inputEditor:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #667eea;
    }

    /* Tab Styling */
    .nav-tabs .nav-link {
        color: #64748b;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        padding: 10px 15px;
        font-size: 13px;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: #667eea;
        border-bottom-color: #667eea;
        background-color: #e2e8f0;
    }

    .nav-tabs .nav-link.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background-color: white;
    }

    /* Button Styling -->
    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .btn-info:hover {
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    /* Test Result Styling -->
    .test-pass {
        color: #10b981;
        background-color: #ecfdf5;
        border-left: 4px solid #10b981;
        padding: 10px 12px;
        margin: 8px 0;
        border-radius: 4px;
        font-size: 13px;
    }

    .test-fail {
        color: #dc2626;
        background-color: #fef2f2;
        border-left: 4px solid #dc2626;
        padding: 10px 12px;
        margin: 8px 0;
        border-radius: 4px;
        font-size: 13px;
    }

    /* Card Hover Effect */
    .card {
        transition: all 0.3s ease;
    }

    .sticky-top {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Syntax Highlighting for Code */
    pre code {
        color: #e2e8f0;
    }
</style>

<script>
    const runBtn = document.getElementById('runBtn');
    const testBtn = document.getElementById('testBtn');
    const clearBtn = document.getElementById('clearBtn');
    const submitBtn = document.getElementById('submitBtn');
    const codeEditor = document.getElementById('codeEditor');
    const inputEditor = document.getElementById('inputEditor');
    const outputEditor = document.getElementById('outputEditor');
    const testResults = document.getElementById('testResults');
    const languageSelect = document.getElementById('languageSelect');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const testCases = @Html.Raw(testsJson);

    // Run code with Piston API
    runBtn.addEventListener('click', async () => {
        const code = codeEditor.value.trim();
        const input = inputEditor.value;
        const language = languageSelect.value;

        if (!code) {
            outputEditor.textContent = 'Error: Code editor is empty!';
            return;
        }

        loadingSpinner.classList.remove('d-none');
        runBtn.disabled = true;
        outputEditor.textContent = 'Executing code with Piston...';

        try {
            const response = await fetch('@Url.Action("ExecuteCodeWithPiston", "Problemes")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code,
                    language: language,
                    input: input
                })
            });

            if (response.ok) {
                const result = await response.json();
                console.log('✅ Piston API Success:', result);
                
                let displayText = '';
                
                if (result.compile && result.compile.stderr) {
                    displayText += '=== Compilation Error ===\n';
                    displayText += result.compile.stderr + '\n\n';
                }
                
                if (result.output) {
                    displayText += result.output;
                } else if (result.stdout) {
                    displayText += result.stdout;
                }
                
                if (result.stderr) {
                    displayText += '\n=== Runtime Error ===\n';
                    displayText += result.stderr;
                }
                
                if (result.exitCode !== null && result.exitCode !== 0) {
                    displayText += `\n\n[Process exited with code ${result.exitCode}]`;
                }
                
                if (result.language && result.version) {
                    displayText += `\n\n[Executed with ${result.language} ${result.version}]`;
                }

                outputEditor.textContent = displayText || 'Execution completed with no output.';
                document.getElementById('output-tab').click();
            } else {
                const errorData = await response.json();
                console.error('❌ Piston API error:', errorData);
                outputEditor.textContent = `Error: ${errorData.error || 'Failed to execute code'}\n\nDetails: ${errorData.details || 'Unknown error'}`;
            }
        } catch (error) {
            console.error('❌ Execution failed:', error);
            outputEditor.textContent = `Error: Could not execute code\n\n${error.message}\n\nPlease check:\n1. Your internet connection\n2. The Piston API service status\n3. Try again in a moment`;
        } finally {
            loadingSpinner.classList.add('d-none');
            runBtn.disabled = false;
        }
    });

    // Run tests
    testBtn.addEventListener('click', async () => {
        if (!Array.isArray(testCases) || testCases.length === 0) {
            testResults.innerHTML = '<p class="text-warning"><i class="bi bi-exclamation-circle"></i> No test cases defined for this problem.</p>';
            document.getElementById('tests-tab').click();
            return;
        }

        const code = codeEditor.value.trim();
        const language = languageSelect.value;

        if (!code) {
            testResults.innerHTML = '<p class="text-danger"><i class="bi bi-x-circle"></i> Code editor is empty!</p>';
            document.getElementById('tests-tab').click();
            return;
        }

        loadingSpinner.classList.remove('d-none');
        testBtn.disabled = true;
        testResults.innerHTML = '<p>Running tests...</p>';

        let passedTests = 0;
        let failedTests = 0;
        let resultsHtml = '';

        function normalizeOutput(s) {
            if (s === null || s === undefined) return '';
            return String(s).replace(/\r/g, '').trim();
        }

        for (let i = 0; i < testCases.length; i++) {
            const testCase = testCases[i];

            try {
                const response = await fetch('@Url.Action("ExecuteCodeWithPiston", "Problemes")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        language: language,
                        input: testCase.input || ''
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    let actualOutput = normalizeOutput(result.stdout || result.output || '');
                    let expectedOutput = normalizeOutput(testCase.expected || '');

                    // Try to compare as JSON if both look like JSON
                    try {
                        const aParsed = JSON.parse(actualOutput);
                        const eParsed = JSON.parse(expectedOutput);
                        actualOutput = JSON.stringify(aParsed);
                        expectedOutput = JSON.stringify(eParsed);
                    } catch (e) {
                        // Not JSON - leave as strings
                    }

                    if (actualOutput === expectedOutput) {
                        passedTests++;
                        resultsHtml += `<div class="test-pass"><i class="bi bi-check-circle-fill"></i> <strong>Test ${i + 1}:</strong> PASSED</div>`;
                    } else {
                        failedTests++;
                        resultsHtml += `<div class="test-fail"><i class="bi bi-x-circle-fill"></i> <strong>Test ${i + 1}:</strong> FAILED<br/>Expected: ${expectedOutput}<br/>Got: ${actualOutput}</div>`;
                    }
                } else {
                    failedTests++;
                    resultsHtml += `<div class="test-fail"><i class="bi bi-x-circle-fill"></i> <strong>Test ${i + 1}:</strong> ERROR executing test</div>`;
                }
            } catch (error) {
                failedTests++;
                resultsHtml += `<div class="test-fail"><i class="bi bi-x-circle-fill"></i> <strong>Test ${i + 1}:</strong> ${error.message}</div>`;
            }
        }

        const summary = `<div style="background-color: #f1f5f9; padding: 12px; border-radius: 4px; margin-bottom: 12px; font-weight: bold;">
            <span style="color: #10b981;"><i class="bi bi-check-circle"></i> ${passedTests} Passed</span>
            <span style="margin-left: 20px; color: #dc2626;"><i class="bi bi-x-circle"></i> ${failedTests} Failed</span>
            <span style="margin-left: 20px; color: #0891b2;"><i class="bi bi-info-circle"></i> ${testCases.length} Total</span>
        </div>`;

        testResults.innerHTML = summary + resultsHtml;
        document.getElementById('tests-tab').click();

        loadingSpinner.classList.add('d-none');
        testBtn.disabled = false;
    });

    // Clear editor
    clearBtn.addEventListener('click', () => {
        if (confirm('Clear all editors?')) {
            codeEditor.value = '';
            inputEditor.value = '';
            outputEditor.textContent = 'Output will appear here...';
            testResults.innerHTML = '<p class="text-muted">Run tests to see results</p>';
            codeEditor.focus();
        }
    });

    // Submit solution
    submitBtn.addEventListener('click', () => {
        const code = codeEditor.value.trim();
        if (!code) {
            alert('Please write some code before submitting!');
            return;
        }
        alert('Solution submitted successfully!');
        // TODO: Save to database using AJAX
    });

    // Tab key support in code editor
    codeEditor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = codeEditor.selectionStart;
            const end = codeEditor.selectionEnd;
            codeEditor.value = codeEditor.value.substring(0, start) + '\t' + codeEditor.value.substring(end);
            codeEditor.selectionStart = codeEditor.selectionEnd = start + 1;
        }
    });

    // Auto-select code tab on load
    codeEditor.focus();
</script>
