@model ProblemSolvingPlatform.Models.Probleme
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ProblemSolvingPlatform.Models.User> SignInManager
@inject UserManager<ProblemSolvingPlatform.Models.User> UserManager

@{
    Layout = "_Layout";
    ViewData["Title"] = "Problem Details";
    var isAdmin = User.IsInRole("Admin");

    var testsJson = "[]";
    if (!string.IsNullOrEmpty(Model.TestCases))
    {
        try
        {
            var parsed = System.Text.Json.JsonSerializer.Deserialize<object>(Model.TestCases);
            testsJson = System.Text.Json.JsonSerializer.Serialize(parsed);
        }
        catch
        {
            testsJson = "[]";
        }
    }
}

<!-- HERO -->
<div class="container-fluid page-hero">
    <div class="inner-hero">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h1 class="fw-bold mb-2 hero-title"><i class="bi bi-code-square"></i> @Model.Title</h1>
                <p class="mb-0 hero-subtitle"><i class="bi bi-hash"></i> Problem #@Model.ProbId</p>
            </div>
            <div class="text-end">
                <a asp-action="Index" class="btn btn-light btn-sm"><i class="bi bi-arrow-left"></i> Back to Problems</a>
            </div>
        </div>
        <div class="d-flex gap-2">
            <span class="badge difficulty-badge"><i class="bi bi-speedometer2"></i> @Model.Difficulte</span>
            <span class="badge lang-badge"><i class="bi bi-code"></i> @(Model.Language?.ToUpper() ?? "PYTHON")</span>
        </div>
    </div>
</div>

<div class="container-fluid page-content">
    <div class="row g-4 details-layout">
        <!-- Left -->
        <div class="col-lg-3">
            <div class="card details-card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">@Model.Title</h5>
                    @if (!string.IsNullOrEmpty(Model.FunctionTemplate))
                    {
                        <h6 class="mt-3 mb-2">Function Template</h6>
                        <pre class="function-template"><code>@Model.FunctionTemplate</code></pre>
                    }
                    <h6 class="mt-4 mb-2">Description</h6>
                    <div class="problem-description mb-3">@Html.Raw(Model.Descr)</div>
                    <div class="mt-3 d-flex gap-2">
                        @if (isAdmin)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.ProbId" class="btn btn-sm btn-warning">Edit</a>
                            <a asp-action="Delete" asp-route-id="@Model.ProbId" class="btn btn-sm btn-danger">Delete</a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Editor -->
        <div class="col-lg-9">
            <div class="card editor-card shadow-sm">
                <div class="card-header editor-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 editor-title"><i class="bi bi-terminal"></i> Code Compiler</h5>
                        <small class="text-muted">Run and test your solution</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <select id="languageSelect" class="form-select form-select-sm language-select">
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="csharp">C#</option>
                        </select>
                    </div>
                </div>

                <div class="card-body p-0 editor-body" style="min-height:480px; display:flex; flex-direction:column;">
                    <div class="tab-content flex-grow-1" id="editorTabContent" style="display:flex; flex-direction:column;">
                        <div id="monaco-editor-container" style="flex:1 1 auto; height:40vh; width:100%; border-radius:4px; overflow:hidden; background:#0b1220;"></div>

                        <!-- Fallback textarea shown by default; Monaco will hide it on success -->
                        <textarea id="codeEditor" class="form-control mt-2" style="min-height:220px;">@(string.IsNullOrEmpty(Model.FunctionTemplate) ? "def solution():\n    pass" : Model.FunctionTemplate)</textarea>

                        <div class="mt-2 px-2">
                            <label for="inputEditor" class="form-label small text-muted">Custom Input (optional)</label>
                            <textarea id="inputEditor" class="form-control io-editor" rows="2" placeholder="Enter custom input..."></textarea>
                        </div>

                        <div id="testResults" class="p-3" style="background:#0b1220; color:#e6eef8; display:none;">
                            <!-- Filled by JS -->
                        </div>
                    </div>

                    <div class="card-footer editor-footer d-flex gap-2">
                        <button id="runBtn" class="btn btn-success flex-grow-1"><i class="bi bi-play-fill"></i> Run</button>
                        <button id="testBtn" class="btn btn-info"><i class="bi bi-check-circle"></i> Run Tests</button>
                        <button id="clearBtn" class="btn btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Clear</button>
                        <button id="submitBtn" class="btn btn-primary"><i class="bi bi-upload"></i> Submit</button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h6>Output</h6>
                    <pre id="outputEditor" class="io-output bg-dark text-white p-3" style="min-height:120px;">Output will appear here...</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
:root{ --bg-dark:white; --accent:#667eea; }
.page-hero{ background:linear-gradient(135deg,#29384b 0%,#0f172a 100%); color:#fff; padding:22px 0; }
.inner-hero{ max-width:1400px; margin:0 auto; padding:0 16px; }
.hero-title{ font-size:1.6rem; }
.page-content{ padding:20px 16px; }

/* Use a flex layout for the details row so columns stay side-by-side and fill the width */
.details-layout{
  display:flex;
  flex-wrap:nowrap; /* prevent wrapping to keep both columns on one line */
  align-items:flex-start;
  gap:2rem !important;
}

/* Fix the column sizes when using the custom flex row */
.details-layout > .col-lg-3{ flex: 0 0 25%; max-width:25%; }
.details-layout > .col-lg-9{ flex: 0 0 75%; max-width:75%; }

.details-card{ border-radius:8px; }
.problem-description{ color:#d1d7e0; }
.function-template{ background:#111827; color:#e6eef8; padding:12px; border-radius:6px; }
.editor-header{ background:linear-gradient(135deg,#0b1220 0%,#122033 100%); color:#e6eef8; }
.language-select{ width:160px; background-color:rgba(255,255,255,0.03); border:none; color:#e6eef8; }
.io-output{ background:#08101a; color:#e6eef8; font-family:'JetBrains Mono', monospace; }
.editor-footer{ background:transparent; border-top:none; }

/* Responsive fallback: stack columns on small screens */
@@media (max-width:991px){ 
  .details-layout{ display:block; }
  .details-layout > .col-lg-3, .details-layout > .col-lg-9{ flex-basis:100%; max-width:100%; width:100%; }
  #monaco-editor-container{ height:30vh !important; }
}
</style>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        var editor = null;
        const testCases = @Html.Raw(testsJson);
        const initialCode = document.getElementById('codeEditor').value;
        const monacoContainer = document.getElementById('monaco-editor-container');
        const textareaFallback = document.getElementById('codeEditor');
        const outputEditor = document.getElementById('outputEditor');
        const testResults = document.getElementById('testResults');

        // Safe Monaco loader
        try {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                try {
                    editor = monaco.editor.create(monacoContainer, {
                        value: initialCode,
                        language: 'python',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        fontSize: 14,
                        minimap: { enabled: false }
                    });
                    // hide textarea when Monaco ready
                    textareaFallback.style.display = 'none';
                    // map language
                    document.getElementById('languageSelect').addEventListener('change', function(e){
                        var lang = e.target.value;
                        var monacoLang = 'python';
                        if(lang==='javascript') monacoLang='javascript';
                        if(lang==='java') monacoLang='java';
                        if(lang==='cpp') monacoLang='cpp';
                        if(lang==='csharp') monacoLang='csharp';
                        monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
                    });
                } catch (err) {
                    console.error('Monaco init failed', err);
                    monacoContainer.style.display = 'none';
                    textareaFallback.style.display = 'block';
                }
            });
        } catch (err) {
            console.error('Require/Monaco load failed', err);
            monacoContainer.style.display = 'none';
            textareaFallback.style.display = 'block';
        }

        function getCodeValue(){
            return editor ? editor.getValue() : document.getElementById('codeEditor').value;
        }

        document.getElementById('runBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            const input = document.getElementById('inputEditor').value || '';
            if(!code){ alert('Please write code'); return; }
            outputEditor.textContent = 'Running...';

            try{
                const resp = await fetch('@Url.Action("ExecuteCodeWithPiston","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ code: code, language: language, input: input })
                });

                if(resp.ok){
                    const data = await resp.json().catch(()=>null);
                    let out = (data && (data.output || data.stdout)) || '';
                    if(data && data.stderr) out += '\n\nError:\n' + data.stderr;
                    if(data && data.compile && data.compile.stderr) out = 'Compilation Error:\n' + data.compile.stderr;
                    outputEditor.textContent = out || 'Execution completed with no output.';
                    testResults.style.display = 'none';
                } else {
                    // try to extract meaningful error message
                    let msg = '';
                    try{ const j = await resp.json(); msg = j?.error || j?.message || JSON.stringify(j); } catch { msg = await resp.text(); }
                    outputEditor.textContent = 'Execution failed: ' + (msg || resp.statusText);
                }
            } catch(e){ outputEditor.textContent = 'Error: '+ e.message; }
        });

        document.getElementById('testBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            if(!code){ alert('Please write code'); return; }
            if(!Array.isArray(testCases) || testCases.length===0){ alert('No test cases defined'); return; }

            testResults.style.display = 'block';
            testResults.innerHTML = '<div class="d-flex flex-column align-items-center mt-3"><div class="spinner-border text-primary mb-2"></div><div class="text-white-50">Running tests...</div></div>';

            try{
                const resp = await fetch('@Url.Action("RunTests","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ Code: code, Language: language, Tests: testCases })
                });

                if(resp.ok){
                    const data = await resp.json().catch(()=>null);

                    function normalize(val){
                        if(val === null || val === undefined) return '';
                        if(typeof val === 'object') return JSON.stringify(val);
                        return String(val).replace(/\r/g,'').trim();
                    }

                    function tryParseJson(str){
                        try{ return JSON.parse(str); } catch { return null; }
                    }

                    function escapeHtml(unsafe){
                        return String(unsafe)
                          .replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&#039;');
                    }

                    if(data && data.results && Array.isArray(data.results)){
                        let passed = 0, failed = 0;
                        let html = '<div class="mb-3 p-2"><strong class="text-white">Test Results</strong></div>';

                        data.results.forEach((r,i)=>{
                            const tc = testCases[i] || {};
                            let expected = '';
                            if(tc.expected !== undefined) expected = tc.expected;
                            else if(tc.output !== undefined) expected = tc.output;
                            else if(tc.expectedOutput !== undefined) expected = tc.expectedOutput;

                            let actual = '';
                            if(r.output !== undefined) actual = r.output;
                            else if(r.stdout !== undefined) actual = r.stdout;
                            else if(r.result !== undefined) actual = r.result;
                            else if(r.raw !== undefined) actual = r.raw;
                            else if(r.stdout_raw !== undefined) actual = r.stdout_raw;
                            else actual = r;

                            const normAct = normalize(actual);
                            const normExp = normalize(expected);

                            let match = false;
                            const parsedA = tryParseJson(normAct);
                            const parsedE = tryParseJson(normExp);
                            if(parsedA !== null && parsedE !== null){
                                try{ match = JSON.stringify(parsedA) === JSON.stringify(parsedE); } catch { match = normAct === normExp; }
                            } else {
                                match = normAct === normExp;
                            }

                            if(r.status && r.status.toLowerCase() === 'error'){
                                failed++;
                                html += `<div class="mb-3 p-3 rounded bg-danger bg-opacity-10 border border-danger"><strong class="text-danger">Test ${i+1} - Error</strong><div class="mt-2"><pre class="mb-0">${escapeHtml(r.error || JSON.stringify(r))}</pre></div></div>`;
                            } else if(match){
                                passed++;
                                html += `<div class="mb-2 p-2 rounded bg-success bg-opacity-10 border border-success"><strong class="text-success">Test ${i+1} - Passed</strong></div>`;
                            } else {
                                failed++;
                                html += `<div class="mb-3 p-3 rounded bg-danger bg-opacity-10 border border-danger">
                                            <div><strong class="text-danger">Test ${i+1} - Failed</strong></div>
                                            <div class="mt-2 small"><span class="text-white-50">Input:</span> <pre class="mb-1">${escapeHtml(tc.input ?? tc.args ?? '')}</pre></div>
                                            <div class="row">
                                                <div class="col-md-6"><div class="small text-white-50">Expected</div><pre class="bg-black p-2 text-white">${escapeHtml(normExp)}</pre></div>
                                                <div class="col-md-6"><div class="small text-white-50">Actual</div><pre class="bg-black p-2 text-white">${escapeHtml(normAct)}</pre></div>
                                            </div>
                                        </div>`;
                            }
                        });

                        const summary = `<div class="mb-3 p-3 rounded bg-secondary bg-opacity-10 d-flex justify-content-between align-items-center"><div><strong class="text-white">Summary</strong></div><div><span class="text-success me-3">${passed} Passed</span><span class="text-danger">${failed} Failed</span></div></div>`;
                        testResults.innerHTML = summary + html;
                    } else if(data && (data.raw || data.output)){
                        testResults.innerHTML = `<pre class="text-white">${escapeHtml(data.raw || data.output)}</pre>`;
                    } else {
                        testResults.innerHTML = '<div class="text-white-50">No results returned</div>';
                    }
                } else {
                    let msg = '';
                    try{ const j = await resp.json(); msg = j?.error || j?.message || JSON.stringify(j); } catch { msg = await resp.text(); }
                    testResults.innerHTML = '<div class="text-danger">Failed to run tests: '+ (msg || resp.statusText) +'</div>';
                }
            } catch(e){ testResults.innerHTML = '<div class="text-danger">Error: '+escapeHtml(e.message)+'</div>'; }
        });

        document.getElementById('clearBtn').addEventListener('click', function(){
            if(!confirm('Reset editor to initial template?')) return;
            if(editor) editor.setValue(initialCode);
            else document.getElementById('codeEditor').value = initialCode;
            outputEditor.textContent = 'Output will appear here...';
            testResults.style.display = 'none';
        });

        document.getElementById('submitBtn').addEventListener('click', async function(){
            const code = getCodeValue();
            const language = document.getElementById('languageSelect').value;
            if(!code){ alert('Please write code'); return; }
            if(!confirm('Submit your solution?')) return;
            this.disabled = true; const btn = this;

            try{
                const resp = await fetch('@Url.Action("SubmitSolution","Problemes")', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials: 'same-origin',
                    body: JSON.stringify({ ProblemId: @Model.ProbId, Code: code, Language: language })
                });

                if(resp.ok){ const result = await resp.json().catch(()=>null); alert(result?.message || 'Submission complete'); }
                else {
                    // Show server error message when available
                    let errMsg = '';
                    try{ const j = await resp.json(); errMsg = j?.error || j?.message || JSON.stringify(j); } catch { errMsg = await resp.text(); }
                    alert('Submission failed: ' + (errMsg || resp.statusText));
                }
            } catch(e){ alert('Error: ' + e.message); }
            finally{ btn.disabled = false; }
        });
    </script>
}

